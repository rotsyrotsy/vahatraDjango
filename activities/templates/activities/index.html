{% extends "association/base.html" %}
{% load static %}
{% load activities_extras %}
{% block title %}{{type_visite.type}}{% endblock %}
{% block content %}
<section>
    <div class="gap remove-bottom black-layer2 opc1">
        <div class="fixed-bg" style="background-image: url({% static 'images/site/fond1.png' %});">
        </div>
        <div class="container">
            <div class="page-title-wrap">
                <h1><img src="{% static 'images/site/lettre.png' %}" alt="lettre.png"></h1>
                <h2>{{type_visite.type|title}}</h2>
                <ul class="breadcrumbs">
                    <li><a href="{% url 'association:index' %}" title="">Home</a></li>
                    <li>{{type_visite.type}}</li>
                </ul>
            </div><!-- Page Title Wrap -->
        </div>
    </div>
</section>
<section>
    <div class="gap">
        <div class="container">
            <div class="hstry-wrap">
                <div class="row">
                    <div class="col-md-12 col-sm-12 col-lg-12">
                        <div class="hstry-desc">
                            <span>About the</span>
                            <h2>{{type_visite.type|title}}</h2>
                            {% if type_visite.id == "SA1" %}
                                <p>Wide dissemination of information on biodiversity and its relationship to human well-being, listening and use of knowledge and perception of local natural resource is a spearhead to better engage the different social strata in a correct biodiversity management and conservation. It is from this perspective and to return to the source that the Association Vahatra promoted a new project entitled "Science for the People" was designed and implemented in the northwest and northeast of Madagascar. The goal is to share scientific data on biodiversity and ecosystems that surround them to the local population and explain the interest generated by these resources to humanity, and on the other side to start understanding to how these local populations understand this natural heritage.</p>
                                <strong>Activities conducted</strong>
                                <ul>
                                    <li>Training of students through visits to schools and villages.</li>
                                    <li>Educational games.</li>
                                    <li>Screening of documentary films.</li>
                                    <li>Exchanges and discussions with adults.</li>
                                    <li>Distribution of printed materials and school kits (t-shirts, books, magazines such as Vintsy and brochures.</li>
                                </ul>
                            {%endif%}
                            {% if type_visite.id == "SA2" %}
                                <p>Over the course of the past 18 years, the ETP and now <span>Vahatra</span> have conducted field schools on a nearly yearly basis for young graduate students enrolled in both national and foreign university systems (Antananarivo, Mahajanga, Toliara, and KwaZulu Natal in South Africa). In most cases, these field trips and associated biological inventories are the first contact these students have with researchers, field techniques, and forest-dwelling animals. During these field schools, which normally last 10-14 days, the participating students form small groups and rotate every few days between the different disciplines represented. Hence, they are exposed to a wide range of ideas, instruction, and practical aspects that will help them during their own graduate studies. Further, while in the field, the participating researchers, mostly composed of professional Malagasy scientists, present seminars to form a clear bridge between theoretical facets presented in university classrooms and practical aspects of obtaining field data.</p>
                            {%endif%}
                            {% if type_visite.id == "SA3" %}
                                <p>Over the past 18 years, over 430 sites have been the subjects of multi-disciplinary biological inventories by the former ETP group and more recently by Vahatra scientists. Here are a few examples of some of the localities visited and the context of the project.  In numerous cases, multiple sites were surveyed at a given locality</p>
                            {%endif%}

                        </div>
                    </div>
                </div>
            </div><!-- History Wrap -->
            <br>
            
        </div>
    </div>
</section>


<section>
    <div class="container">
        <div class="bord-wrap">
            <div class="row mrg  mycaroussel-simple">
                
                {% for visit in visits %}
                    <div class="col-md-3 col-sm-6 col-lg-3">
                        <div class="bord-box">
                            {% if visit.idactivity.activityimage_set.all %}
                                {% with visit.idactivity.activityimage_set.all|first as image %}
                                <img src="{% static 'images/site/' %}{{image.image}}" alt="{{image.image}}" alt="" width="100" height="100">
                                {% endwith %}
                            {% endif %}
                            
                            <div class="bord-info">
                                <h4>{{visit.idlocation.name}}</h4>
                                <p>Date: {{visit.idactivity.date}} - {{visit.dateend|default_if_none:""}}</p>
                                <span><a  title="" onclick="clickImage('{{visit.idlocation.id}}')">Show more<i class="flaticon-right-arrow"></i></a></span>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                
            </div>
        </div>
    </div>
    <div class="gap ">
        
        <div class="row no-gutters" >
            <div class="col-md-12 col-sm-12 col-lg-12" id="divmap">
                <div id="mapvisit" class="map" style="width: 100%; height: 600px; z-index: 0;" ></div>
            </div>
            
            <div class="col-md-3 col-sm-12 col-lg-3">
                <div id="mySidebar" class="event-box2 sidebarcustom">
                    <a href="javascript:void(0)" class="closebtncustom" onclick="closeNav()">Ã—</a>
                    <div class="event-thumb">
                        <a href="#"  title=""><img id="imagevisit" src="{% static 'images/resources/event-img3.jpg' %} " data-url="{% static 'images/site/' %}" alt="event-img2-1.jpg"></a>
                    </div>
                    <div class="event-info">
                    </div>
                  </div>
            </div>
        </div>
    </div>
</section>

{% endblock content %}

{% block js %}

<script type="text/javascript"> 
    
    
    var img="{% static 'images/map-icon.png' %}";
    var map = new ol.Map({
        target: 'mapvisit',
        layers: [
        new ol.layer.Tile({
            source: new ol.source.OSM()
        })
        ],
        view: new ol.View({
        center: ol.proj.fromLonLat([ 47.5511327993, -18.9167]),
        zoom: 5.5
        })
    });

    "{% for visit in visits %}"
        var layer = new ol.layer.Vector({
            source: new ol.source.Vector({
                features: [
                    new ol.Feature({
                        geometry: new ol.geom.Point(ol.proj.fromLonLat(['{{visit.idlocation.longitude | float_comma_to_dot }}','{{visit.idlocation.latitude | float_comma_to_dot }}'])),
                        id: "{{visit.idlocation.id}}"
                    })
                        
                ]
            }),
            style: new ol.style.Style({
                image: new ol.style.Icon({
                    anchor: [0.5, 1.0],
                    
                    src: img,
                    
                    scale: 0.3
                })
            })
            
        });
        layer.set("id","{{visit.idlocation.id}}")
        map.addLayer(layer);

        
    "{% endfor %}"

    
    var selected = null;
    var lesvisites = null;
    var lelieu = null;

    function extendMarker(idlocation,openFiche){
            $.ajax({
                url : "{% url 'activities:visit_by_lieu' %}",
                dataType: 'JSON',
                type:"GET",
                data:{lieu_id:idlocation, id_visit_type:"{{type_visite.id}}"},
                success:function(data){
                    lelieu = JSON.parse(data["lieu"])[0];
                    lesvisites = data["visits"];
                    var newstyle =  new ol.style.Style({
                        image: new ol.style.Icon({
                            anchor: [0.5, 1.0],
                            src:  "{% static 'images/map-icon-green.png' %}",
                            scale: 0.5
                        }),
                        text : new ol.style.Text({
                            text: lelieu['fields']['name'],
                            scale: 1.5,
                            fill: new ol.style.Fill({
                                color: 'black'
                            })
                        })
                    })
                    if (selected!=null){
                        selected.setStyle(newstyle);
                    }
                    if (openFiche==1){
                        openNav("{{type_visite.type}}", lelieu['fields']['name'], lesvisites);
                    }
                },
                error:function(data){
                    // console.log('error')
                    // console.log(data)
                }
            });
    }


    map.on('pointermove', function (e) {

        map.forEachFeatureAtPixel(e.pixel, function (f) {
            
            map.getLayers().forEach(function (lyr) {
                if (f.get("id") == lyr.get('id')) {  
                    if (selected !== null) {
                        selected.setStyle(undefined);
                        selected = null;
                    }
                    selected = f;
                    extendMarker(f.get("id"),0);
                }            
            });
            
           

        });
    });
    
    map.on('singleclick', function (evt) {
            if (selected!=null && lelieu!=null && lesvisites!=null){
                openNav("{{type_visite.type}}", lelieu['fields']['name'], lesvisites);
            }
        });

    function clickImage(idlocation){
        map.getLayers().forEach(function (layer) {
            if (idlocation == layer.get('id')) {
                var source = layer.getSource();
                var features = source.getFeatures(); 

                if (selected !== null) {
                    selected.setStyle(undefined);
                    selected = null;
                }
                
                selected = features[0];
                
                extendMarker(features[0].get("id"),1);
            }            
        });
    }
    
</script>
{% endblock %}